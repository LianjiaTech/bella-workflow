import { CodeGroup } from '../code.tsx'
import { Row, Col, Properties, Property, Heading, SubProperty, Paragraph } from '../md.tsx'

# Workflow API

<div>
  ### Base URL
  <CodeGroup title="Code" targetCode={props.appDetail.api_base_url}>
    ```javascript
    ```
  </CodeGroup>

  ### Authentication

Bella Workflow API 使用 `API-Key` 进行鉴权。
  <i>**强烈建议开发者把 `API-Key` 放在后端存储，而非分享或者放在客户端存储，以免 `API-Key` 泄露，导致财产损失。**</i>
  所有 API 请求都应在 **`Authorization`** HTTP Header 中包含您的 `API-Key`，如下所示：

  <CodeGroup title="Code">
    ```javascript
      Authorization: Bearer {API_KEY}

    ```
  </CodeGroup>
</div>

---

<Heading
  url='/workflow/run'
  method='POST'
  title='执行 workflow'
  name='#Execute-Workflow'
/>
<Row>
  <Col>
    执行 workflow，没有已发布的 workflow，不可执行。

    ### Request Body
      - `tenantId` (string) Required
        租户ID，取值看右边请求示例
      - `workflowId` (string) Required
        工作流ID，取值看右边请求示例
      - `query` (string) Optional
        Chatflow模式必传，用户的输入/提问
      - `files` (array) Optional
        用户上传的文件
      - `inputs` (object) Required
        允许传入 workflow start 节点定义的各变量值。
        inputs 参数包含了多组键值对（Key/Value pairs），每组的键对应一个特定变量，每组的值则是该变量的具体值。
      - `responseMode` (string) Required
        返回响应模式，支持：
        - `streaming` 流式模式（推荐）。基于 SSE（**[Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events)**）实现类似打字机输出方式的流式返回。
        - `blocking` 阻塞模式，等待执行完毕后返回结果。（请求若流程较长可能会被中断）。
        - `callback` 回调模式，执行任务提交后立即返回，工作流运行完成时回调到指定的`callbackUrl`
        <i>长时间运行的任务请优先考虑callback模式</i>
      - `userId` (Long) Required
        用户标识，Ke内必须使用ucid。
      - `userName` (string) Required
        用户名，Ke内用户必须使用与userId相匹配的真实姓名。
      - `callbackUrl` (string) Optional
        回调地址，当 `responseMode` 为 `callback` 时，必填。当workflow执行结束，会以post请求的方式回调callbackUrl。
      - `metadata` (object) Optional
        随路数据，在工作流中可以通过sys.metadata引用，长度不超过4096
      - `flashMode` (int) Optional
        极速模式，设置大于0的值时，工作流执行将不再保存node执行的过程数据，响应时间会更快。默认值为1。
        <i>callback模式下无效</i>

    ### Response
    当 `responseMode` 为 `blocking` 时，返回 CompletionResponse object。
    当 `responseMode` 为 `streaming`时，返回 ChunkCompletionResponse object 流式序列。

    ### CompletionResponse
    返回完整的 App 结果，`Content-Type` 为 `application/json` 。
    - `code` (number) workflow状态码
    - `data` (object) 详细内容
      - `workflowRunId` (string) workflow 执行 ID
      - `workflow_id` (string) 关联 Workflow ID
      - `status` (string) 执行状态, `running` / `succeeded` / `failed` / `stopped`
      - `outputs` (json) Optional 输出内容
      - `error` (string) Optional 错误原因

    ### ChunkCompletionResponse
    返回 App 输出的流式块，`Content-Type` 为 `text/event-stream`。
    每个流式块块之间以 `\n\n` 即两个换行符分隔，如下所示：
    <CodeGroup>
    ```streaming {{ title: 'Response' }}
    event:onWorkflowRunSucceeded
    id:onWorkflowRunSucceeded
    data:{"tenantId":"${props.appDetail.tenantId}","workflowId":"${props.appDetail.id}","workflowRunId":"RUN-2407191108200101000002","status":"succeeded","outputs":{"text":"Hello! How can I help?"}}\n\n
    ```
    </CodeGroup>
    流式块中根据 `event` 不同，结构也不同，具体参考右侧的示例。

    ### Errors
    - 400，请求参数错误
    - 500，服务内部异常

  </Col>
  <Col sticky>
     <CodeGroup title="Request" tag="POST" label="/workflow/run" targetCode={`curl -X POST '${props.appDetail.api_base_url}/workflow/run' \\\n--header 'Authorization: Bearer {api_key}' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n    "tenantId": "${props.appDetail.tenantId}",\n    "workflowId": "${props.appDetail.id}",\n    "inputs": ${JSON.stringify(props.inputs)},\n    "responseMode": "streaming",\n    "userId": "1000123"\n}'\n`}>

    ```bash {{ title: 'cURL' }}
    curl -X 'POST' \
      '${props.appDetail.api_base_url}/workflow/run' \
      -H 'Content-Type: application/json' \
      -d '{
      "userId": 0,
      "userName": "string",
      "tenantId": "${props.appDetail.tenantId}",
      "workflowId": "${props.appDetail.id}",
      "inputs": ${JSON.stringify(props.inputs)},
      "responseMode": "streaming"
    }'
    ```

    </CodeGroup>
    ### Blocking Mode
    <CodeGroup title="Response" targetCode={`{\n  "code":200,\n  "message":null,\n  "timestamp":0,\n  "data":{\n    "tenantId":"${props.appDetail.tenantId}",\n    "workflowId":"${props.appDetail.id}",\n    "workflowRunId":"RUN-2407191127220101000001",\n    "status":"succeeded",\n    "outputs":{"text":"Hi there! How can I help?"}\n  },\n  "stacktrace":null\n}`}>
    ```json {{ title: 'Response' }}
    {
      "code": 200,
      "message": null,
      "timestamp": 0,
      "data": {
        "tenantId": "${props.appDetail.tenantId}",
        "workflowId": "${props.appDetail.id}",
        "workflowRunId": "RUN-2407191127220101000001",
        "status": "succeeded",
        "outputs": {
          "text": "Hi there! How can I help?"
        }
      },
      "stacktrace": null
    }
    ```
    </CodeGroup>
    ### Streaming Mode
    <CodeGroup title="Response">
    ```streaming {{ title: 'Response' }}
event:onWorkflowRunStarted
id:onWorkflowRunStarted
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","meta":{"graph":{"edges":[{"data":{"sourceType":"start","targetType":"llm","inIteration":false,"iterationId":null},"id":"1721283608337-1721355322231","source":"1721283608337","sourceHandle":"source","target":"1721355322231","targetHandle":"target","type":"custom","key":"1721283608337/source-1721355322231/target"},{"data":{"sourceType":"llm","targetType":"end","inIteration":false,"iterationId":null},"id":"1721355322231-1721355324799","source":"1721355322231","sourceHandle":"source","target":"1721355324799","targetHandle":"target","type":"custom","key":"1721355322231/source-1721355324799/target"}],"nodes":[{"data":{"variables":[{"variable":"query","label":"query","type":"text-input","max_length":48,"required":true,"isRoot":true,"options":[],"varType":"object","children":[]}],"name":"开始","type":"start","title":"开始节点","selected":false},"dragging":false,"height":90,"id":"1721283608337","position":{"x":99,"y":100},"positionAbsolute":{"x":99,"y":100},"selected":false,"sourcePosition":"right","targetPosition":"left","type":"start","width":244,"inIteration":false,"iterationId":null,"iterationStart":false,"title":"开始节点"},{"data":{"type":"llm","title":"LLM","desc":"","variables":[],"model":{"provider":"openai","name":"c4ai-command-r-plus","mode":"chat","completion_params":{"temperature":0.7}},"prompt_template":[{"role":"system","text":"","id":"fbef3668-c1b5-4f27-aed6-03a27a43616d"},{"role":"user","text":"{{#1721283608337.query#}}"}],"context":{"enabled":false,"variable_selector":[]},"vision":{"enabled":false},"selected":false},"dragging":false,"height":98,"id":"1721355322231","position":{"x":399,"y":100},"positionAbsolute":{"x":399,"y":100},"selected":true,"sourcePosition":"right","targetPosition":"left","type":"llm","width":244,"inIteration":false,"iterationId":null,"iterationStart":false,"title":"LLM"},{"data":{"type":"end","title":"结束","desc":"","outputs":[{"variable":"text","value_selector":["1721355322231","text"]}],"selected":false},"dragging":false,"height":90,"id":"1721355324799","position":{"x":699,"y":100},"positionAbsolute":{"x":699,"y":100},"selected":false,"sourcePosition":"right","targetPosition":"left","type":"end","width":244,"inIteration":false,"iterationId":null,"iterationStart":false,"title":"结束"}],"viewport":{"x":80,"y":126,"zoom":1.0}}}}

event:onWorkflowNodeRunStarted
id:onWorkflowNodeRunStarted
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721283608337","nodeType":"start"}

event:onWorkflowNodeRunSucceeded
id:onWorkflowNodeRunSucceeded
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721283608337","nodeType":"start","result":{"inputs":{"query":"hello"},"processData":null,"outputs":null,"error":null,"status":"succeeded","elapsedTime":70,"activatedSourceHandles":["source"]}}

event:onWorkflowNodeRunStarted
id:onWorkflowNodeRunStarted
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm"}

event:onWorkflowNodeRunProgress
id:onWorkflowNodeRunProgress
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm","progress":{"progress":0,"object":null,"data":{"id":"cmpl-10e001aa525042bd8c3d7e83d9e5e9ab","object":null,"created":5610340,"model":"c4ai-command-r-plus","choices":[{"index":0,"message":{"role":"assistant","role":"assistant","content":"Hello","name":null,"tool_calls":null,"function_call":null},"logprobs":null,"finish_reason":null}],"usage":{"prompt_tokens":162,"completion_tokens":1,"total_tokens":163},"system_fingerprint":null}}}

event:onWorkflowNodeRunProgress
id:onWorkflowNodeRunProgress
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm","progress":{"progress":0,"object":null,"data":{"id":"cmpl-10e001aa525042bd8c3d7e83d9e5e9ab","object":null,"created":5610340,"model":"c4ai-command-r-plus","choices":[{"index":0,"message":{"role":"assistant","role":"assistant","content":"!","name":null,"tool_calls":null,"function_call":null},"logprobs":null,"finish_reason":null}],"usage":{"prompt_tokens":162,"completion_tokens":2,"total_tokens":164},"system_fingerprint":null}}}

event:onWorkflowNodeRunProgress
id:onWorkflowNodeRunProgress
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm","progress":{"progress":0,"object":null,"data":{"id":"cmpl-10e001aa525042bd8c3d7e83d9e5e9ab","object":null,"created":5610340,"model":"c4ai-command-r-plus","choices":[{"index":0,"message":{"role":"assistant","role":"assistant","content":" How","name":null,"tool_calls":null,"function_call":null},"logprobs":null,"finish_reason":null}],"usage":{"prompt_tokens":162,"completion_tokens":3,"total_tokens":165},"system_fingerprint":null}}}

event:onWorkflowNodeRunProgress
id:onWorkflowNodeRunProgress
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm","progress":{"progress":0,"object":null,"data":{"id":"cmpl-10e001aa525042bd8c3d7e83d9e5e9ab","object":null,"created":5610340,"model":"c4ai-command-r-plus","choices":[{"index":0,"message":{"role":"assistant","role":"assistant","content":" can","name":null,"tool_calls":null,"function_call":null},"logprobs":null,"finish_reason":null}],"usage":{"prompt_tokens":162,"completion_tokens":4,"total_tokens":166},"system_fingerprint":null}}}

event:onWorkflowNodeRunProgress
id:onWorkflowNodeRunProgress
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm","progress":{"progress":0,"object":null,"data":{"id":"cmpl-10e001aa525042bd8c3d7e83d9e5e9ab","object":null,"created":5610340,"model":"c4ai-command-r-plus","choices":[{"index":0,"message":{"role":"assistant","role":"assistant","content":" I","name":null,"tool_calls":null,"function_call":null},"logprobs":null,"finish_reason":null}],"usage":{"prompt_tokens":162,"completion_tokens":5,"total_tokens":167},"system_fingerprint":null}}}

event:onWorkflowNodeRunProgress
id:onWorkflowNodeRunProgress
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm","progress":{"progress":0,"object":null,"data":{"id":"cmpl-10e001aa525042bd8c3d7e83d9e5e9ab","object":null,"created":5610340,"model":"c4ai-command-r-plus","choices":[{"index":0,"message":{"role":"assistant","role":"assistant","content":" help","name":null,"tool_calls":null,"function_call":null},"logprobs":null,"finish_reason":null}],"usage":{"prompt_tokens":162,"completion_tokens":6,"total_tokens":168},"system_fingerprint":null}}}

event:onWorkflowNodeRunProgress
id:onWorkflowNodeRunProgress
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm","progress":{"progress":0,"object":null,"data":{"id":"cmpl-10e001aa525042bd8c3d7e83d9e5e9ab","object":null,"created":5610340,"model":"c4ai-command-r-plus","choices":[{"index":0,"message":{"role":"assistant","role":"assistant","content":"?","name":null,"tool_calls":null,"function_call":null},"logprobs":null,"finish_reason":null}],"usage":{"prompt_tokens":162,"completion_tokens":7,"total_tokens":169},"system_fingerprint":null}}}

event:onWorkflowNodeRunSucceeded
id:onWorkflowNodeRunSucceeded
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355322231","nodeType":"llm","result":{"inputs":{},"processData":{"meta_data":{"ttft":346,"ttlt":508,"tokens":7},"model_mode":"chat","prompts":{"prompt_messages":[{"role":"system","content":"","name":null},{"role":"user","content":"hello","name":null}],"model_mode":"chat"}},"outputs":{"text":"Hello! How can I help?"},"error":null,"status":"succeeded","elapsedTime":811,"activatedSourceHandles":["source"]}}

event:onWorkflowNodeRunStarted
id:onWorkflowNodeRunStarted
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355324799","nodeType":"end"}

event:onWorkflowNodeRunSucceeded
id:onWorkflowNodeRunSucceeded
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"running","nodeId":"1721355324799","nodeType":"end","result":{"inputs":null,"processData":null,"outputs":{"text":"Hello! How can I help?"},"error":null,"status":"succeeded","elapsedTime":62,"activatedSourceHandles":[]}}

event:onWorkflowRunSucceeded
id:onWorkflowRunSucceeded
data:{"tenantId":"test","workflowId":"WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e","workflowRunId":"RUN-2407191108200101000002","status":"succeeded","outputs":{"text":"Hello! How can I help?"}}
    ```
    </CodeGroup>
    ### Callback Mode
    <CodeGroup title="Callback Curl">
    ```bash
    curl --location '{callbackUrl}' \
    --header 'Content-Type: application/json' \
    --data '{
        "tenantId": "test",
        "workflowId": "WKFL-fe8c17f6-2faf-4a8f-80cf-9f0596ea7a4e",
        "workflowRunId": "RUN-2407191108200101000002",
        "status": "succeeded",
        "outputs": {
        "text": "Hello! How can I help?"
        }
    }'
    ```
    </CodeGroup>
  </Col>
</Row>
